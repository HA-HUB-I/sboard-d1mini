# Wiring Plan
# Door Contact (D_IN on Sboard III) ‚Üí Connect to a GPIO on the D1 Mini (e.g., GPIO14 or D5).
# Exit Button (OPEN on Sboard III) ‚Üí Connect to a GPIO on the D1 Mini (e.g., GPIO12 or D6).
# Alarm (ALARM- on Sboard III) ‚Üí Connect to a GPIO on the D1 Mini (e.g., GPIO13 or D7).
# Buzzer Control (BZ on Sboard III) ‚Üí Connect to a GPIO on the D1 Mini (e.g., GPIO5 or D1).
# Intercom Opto D2	GPIO4 (HIGH/LOW)

esphome:
  name: d1mini
  friendly_name: D1mini-Sboard

esp8266:
  board: d1_mini

# Enable logging
logger:
  baud_rate: 0

# Enable Home Assistant API
api:
  encryption:
    key: "KEY"
  # Reboot –ø—Ä–∏ –∑–∞–≥—É–±–∞ –Ω–∞ API –≤—Ä—ä–∑–∫–∞
  reboot_timeout: 0s # –ò–∑–∫–ª—é—á–≤–∞–º–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏—è restart

ota:
  platform: esphome

# # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–µ –ø–æ –≤—Ä–µ–º–µ –Ω–∞ update https://esphome.io/components/safe_mode
# safe_mode:

wifi:
  ssid: !secret door_ssid
  password: !secret door_password

  # # Enable fallback hotspot (captive portal) in case wifi connection fails
  # ap:
  #   ssid: "D1 Fallback"
  #   password: "123"
  # –ë—ä—Ä–∑–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ - –Ω–∞–º–∞–ª—è–≤–∞ –≤—Ä–µ–º–µ—Ç–æ –∑–∞ connection
  fast_connect: true

  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞ –ø–æ-—Å—Ç–∞–±–∏–ª–Ω–∞ –≤—Ä—ä–∑–∫–∞
  power_save_mode: none # –ò–∑–∫–ª—é—á–≤–∞ power saving –∑–∞ –ø–æ-—Å—Ç–∞–±–∏–ª–Ω–∞ –≤—Ä—ä–∑–∫–∞

  # –û–ø—Ü–∏–∏ –∑–∞ –ø–æ-–¥–æ–±—Ä–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞
  reboot_timeout: 0s # –ù–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

  # Manual IP –∑–∞ –ø–æ-–±—ä—Ä–∑–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)
  manual_ip:
    static_ip: 192.168.1.8
    gateway: 192.168.1.1
    subnet: 255.255.255.0
    dns1: 8.8.8.8

captive_portal:

# –°–∫—Ä–∏–ø—Ç –∑–∞ –∞–≥—Ä–µ—Å–∏–≤–Ω–æ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ WiFi –≤—Ä—ä–∑–∫–∞—Ç–∞
script:
  - id: check_wifi_connection
    mode: restart
    then:
      - if:
          condition:
            not:
              wifi.connected:
          then:
            - wifi.disable:
            - delay: 3s
            - wifi.enable:
            - delay: 45s # –ò–∑—á–∞–∫–≤–∞ 45 —Å–µ–∫ –∑–∞ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ
            - if:
                condition:
                  not:
                    wifi.connected:
                then:
                  # –û–ø–∏—Ç–≤–∞ –æ—Ç–Ω–æ–≤–æ —Å–ª–µ–¥ 30 —Å–µ–∫—É–Ω–¥–∏
                  - delay: 30s
                  - script.execute: check_wifi_connection
          else:
  # –ù–æ–≤ —Å–∫—Ä–∏–ø—Ç –∑–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª–Ω–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –ø—Ä–∏ –∑–∞–≥—É–±–∞ –Ω–∞ hotspot
  - id: force_wifi_reconnect
    mode: restart
    then:
      - wifi.disable:
      - delay: 5s
      - wifi.enable:
      - delay: 60s # –î–∞–≤–∞ –ø–æ–≤–µ—á–µ –≤—Ä–µ–º–µ –∑–∞ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ
      - if:
          condition:
            not:
              wifi.connected:
          then:
            - delay: 120s # –ò–∑—á–∞–∫–≤–∞ 2 –º–∏–Ω—É—Ç–∏
            - script.execute: force_wifi_reconnect
          else:

# –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏ –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏
interval:
  # –û—Å–Ω–æ–≤–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å—è–∫–∞ –º–∏–Ω—É—Ç–∞
  - interval: 60s
    then:
      - script.execute: check_wifi_connection
  # –ê–≥—Ä–µ—Å–∏–≤–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ–∫–∏ 30 —Å–µ–∫—É–Ω–¥–∏ –∫–æ–≥–∞—Ç–æ –Ω—è–º–∞ –≤—Ä—ä–∑–∫–∞
  - interval: 30s
    then:
      - if:
          condition:
            not:
              wifi.connected:
          then:
            - script.execute: force_wifi_reconnect
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –≤—Å–µ–∫–∏ 5 –º–∏–Ω—É—Ç–∏
  - interval: 300s # 5 –º–∏–Ω—É—Ç–∏
    then:
      - logger.log:
          format: "üìä System status - WiFi: %s, Uptime: %.1f min"
          args:
            - 'id(wifi_connected).state ? "Connected" : "Disconnected"'
            - "id(uptime_sensor).state / 60"
text_sensor:
  - platform: template #rfid posleden skaniran tag
    name: last_tag
    id: rfid_tag

  - platform: template
    name: Last User
    id: last_user
    icon: mdi:clock-start
  - platform: template
    name: "Last Tag Binary"
    id: last_tag_binary

  - platform: template
    name: "Last Tag Full Info"
    id: last_tag_full_info
  # Status —Å–µ–Ω–∑–æ—Ä–∏
  - platform: template
    name: "Wiegand Mode"
    update_interval: 2s
    lambda: |-
      if (id(wiegand_mode)) {
        return {"TX"};
      } else if (id(mode_switching)) {
        return {"Switching"};
      } else {
        return {"RX"};
      }

sensor:
  - platform: wifi_signal
    name: "WiFi Signal Sensor"
    update_interval: 60s

  - platform: uptime
    name: "Uptime Sensor"
    id: uptime_sensor

  - platform: template
    name: "Uptime in Seconds"
    lambda: |-
      return id(uptime_sensor).state;
    unit_of_measurement: "s"
    update_interval: 60s

  - platform: template
    name: "Uptime in Minutes"
    lambda: |-
      return id(uptime_sensor).state / 60;
    unit_of_measurement: "min"
    update_interval: 60s
  # –°–µ–Ω–∑–æ—Ä–∏ –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ –∫—ä–º HA –∑–∞ —Å–∫–∞–Ω–∏—Ä–∞–Ω–∏ —Ç–∞–≥–æ–≤–µ
  - platform: template
    name: "Last Tag Decimal"
    id: last_tag_decimal
    accuracy_decimals: 0

  - platform: template
    name: "Last Tag Hex"
    id: last_tag_hex
    accuracy_decimals: 0

  - platform: template
    name: "Last Facility Code"
    id: last_facility_sensor
    accuracy_decimals: 0

  - platform: template
    name: "Last Card Number"
    id: last_card_sensor
    accuracy_decimals: 0

# Wiegand —á–µ—Ç–µ–Ω–µ —Å –ø—ä–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
wiegand:
  - id: mykeypad
    d0: GPIO3
    d1: GPIO1
    on_tag:
      - if:
          condition:
            lambda: "return !id(mode_switching) && !id(wiegand_mode);"
          then:
            - lambda: |-
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–π –≤ —á–∏—Å–ª–æ
                uint32_t raw_tag = strtoul(x.c_str(), NULL, 10);

                // Binary string
                char binary[33];
                for (int i = 25; i >= 0; i--) {
                  binary[25-i] = (raw_tag & (1UL << i)) ? '1' : '0';
                }
                binary[26] = '\0';

                // –î–µ–∫–æ–¥–∏—Ä–∞–π 26-bit Wiegand
                bool even_parity = (raw_tag >> 25) & 1;
                bool odd_parity = raw_tag & 1;
                uint32_t payload = (raw_tag >> 1) & 0xFFFFFF;

                uint8_t facility = (payload >> 16) & 0xFF;
                uint16_t card = payload & 0xFFFF;

                // –ó–∞–ø–∞–∑–∏ –≤ globals
                id(facility_code) = facility;
                id(card_number) = card;
                id(tag_to_send) = raw_tag;

                // –ü—É–±–ª–∏–∫—É–≤–∞–π –∫—ä–º HA
                id(last_tag_decimal).publish_state(raw_tag);
                id(last_tag_hex).publish_state(raw_tag);
                id(last_facility_sensor).publish_state(facility);
                id(last_card_sensor).publish_state(card);
                id(last_tag_binary).publish_state(binary);

                // Full info string
                char info[128];
                snprintf(info, sizeof(info), 
                         "Dec:%lu Hex:0x%06X FC:%d CN:%d EP:%d OP:%d",
                         raw_tag, raw_tag, facility, card, even_parity, odd_parity);
                id(last_tag_full_info).publish_state(info);

                ESP_LOGI("TAG", "Scanned: FC=%d CN=%d", facility, card);

            # –ò–∑–ø—Ä–∞—Ç–∏ –∫—ä–º HA tag_scanned event
            - homeassistant.tag_scanned: !lambda "return x.c_str();"

# Door Contact Sensor
binary_sensor:
  - platform: template
    name: "TX Active"
    lambda: "return id(wiegand_mode);"

  - platform: gpio
    pin:
      number: D5
      mode: INPUT_PULLUP
    name: "Door Contact"
    device_class: door
    on_press:
      then:
        - logger.log: "Door Opened"
    on_release:
      then:
        - logger.log: "Door Closed"

  - platform: gpio
    id: domofon_unlock_btn
    name: "–î–æ–º–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–≤–∞–Ω–µ"
    pin:
      number: GPIO4
      mode: { input: true, pullup: true }
      inverted: true
    filters: [delayed_on: 30ms, delayed_off: 80ms]

  - platform: gpio
    pin:
      number: D7
      mode: INPUT_PULLUP # Keeps it HIGH when inactive
    name: "Alarm Triggered"
    device_class: safety
    filters:
      - invert: # Since it's active LOW, invert the signal
    on_press:
      then:
        - logger.log: "‚ö†Ô∏è Alarm Activated!"
    on_release:
      then:
        - logger.log: "‚úÖ Alarm Cleared"

  # Status LED (Optional)
  - platform: status
    name: "ESP Status"
    id: esp_status
    on_press:
      then:
        - logger.log: "‚úÖ Device connected to HA"
    on_release:
      then:
        - script.execute: force_wifi_reconnect
  # WiFi —Å—Ç–∞—Ç—É—Å —Å–µ–Ω–∑–æ—Ä
  - platform: template
    name: "WiFi Connected"
    id: wifi_connected
    lambda: |-
      return WiFi.status() == WL_CONNECTED;
    on_press:
      then:
        - logger.log: "üì∂ WiFi connection established"
    on_release:
      then:
        - delay: 5s # –ö—Ä–∞—Ç–∫–æ –∑–∞–±–∞–≤—è–Ω–µ –ø—Ä–µ–¥–∏ –æ–ø–∏—Ç
        - script.execute: force_wifi_reconnect

  - platform: gpio
    pin: GPIO2
    name: "–î–æ–º–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–≤–∞–Ω–µ –≤—Ä–∞—Ç–∞"
    device_class: door
    filters:
      - invert:
      - delayed_on: 10ms
      - delayed_off: 10ms
# –†–µ–∂–∏–º –Ω–∞ —Ä–∞–±–æ—Ç–∞
# –ì–ª–æ–±–∞–ª–Ω–∏ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏
globals:
  - id: wiegand_mode
    type: bool
    initial_value: "false"
    restore_value: no
  - id: mode_switching
    type: bool
    initial_value: "false"
    restore_value: no
  - id: tag_to_send
    type: uint32_t
    initial_value: "0"
    restore_value: no
  - id: facility_code
    type: uint8_t
    initial_value: "0"
    restore_value: no
  - id: card_number
    type: uint32_t
    initial_value: "0"
    restore_value: no

# Number input –∑–∞ —Ç–∞–≥ ID
number:
  - platform: template
    name: "Tag ID to Send"
    id: tag_id_input
    min_value: 0
    max_value: 16777215
    step: 1
    mode: box
    optimistic: true
    on_value:
      - globals.set:
          id: tag_to_send
          value: !lambda "return (uint32_t)x;"
  # Input –∑–∞ Facility Code –∏ Card Number
  - platform: template
    name: "Facility Code"
    id: facility_input
    min_value: 0
    max_value: 255
    step: 1
    mode: box
    optimistic: true
    on_value:
      - globals.set:
          id: facility_code
          value: !lambda "return (uint8_t)x;"

  - platform: template
    name: "Card Number"
    id: card_input
    min_value: 0
    max_value: 65535
    step: 1
    mode: box
    optimistic: true
    on_value:
      - globals.set:
          id: card_number
          value: !lambda "return (uint32_t)x;"
# Buzzer Control
switch:
  - platform: gpio
    pin: D1
    name: "Buzzer"
    restore_mode: ALWAYS_OFF
    icon: "mdi:alarm-bell"

  # Exit button
  - platform: gpio
    pin:
      number: D6
      mode: OUTPUT_OPEN_DRAIN
      inverted: yes # Ensures it sends LOW when activated
    name: "Exit Button"
    icon: "mdi:exit-run"
    on_turn_on:
      - delay: 1s # Keeps it LOW for 1 second
      - switch.turn_off: exit_button
    id: exit_button

  # –ü—Ä–µ–≤–∫–ª—é—á–≤–∞—Ç–µ–ª TX/RX —Ä–µ–∂–∏–º
  - platform: template
    name: "Wiegand TX Mode"
    id: tx_mode_switch
    restore_mode: ALWAYS_OFF
    optimistic: true
    turn_on_action:
      - logger.log: "Switching to TX mode..."
      - globals.set:
          id: mode_switching
          value: "true"
      - delay: 200ms
      - lambda: |-
          // –°–ø—Ä–∏ interrupt-–∏—Ç–µ
          detachInterrupt(digitalPinToInterrupt(3));
          detachInterrupt(digitalPinToInterrupt(1));

          // –ü—Ä–µ–≤–∫–ª—é—á–∏ –≤ OUTPUT
          pinMode(3, OUTPUT);
          pinMode(1, OUTPUT);
          digitalWrite(3, HIGH);
          digitalWrite(1, HIGH);

          ESP_LOGI("WIEGAND", "TX mode activated");
      - delay: 100ms
      - globals.set:
          id: mode_switching
          value: "false"
      - globals.set:
          id: wiegand_mode
          value: "true"
      # Watchdog - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–∫–ª—é—á–≤–∞–Ω–µ
      - delay: 30s
      - if:
          condition:
            switch.is_on: tx_mode_switch
          then:
            - logger.log:
                level: WARN
                format: "TX timeout! Auto-switching to RX"
            - switch.turn_off: tx_mode_switch

    turn_off_action:
      - logger.log: "Switching to RX mode..."
      - globals.set:
          id: wiegand_mode
          value: "false"
      - lambda: |-
          // –í—ä—Ä–Ω–∏ –≤ INPUT
          digitalWrite(3, HIGH);
          digitalWrite(1, HIGH);
          pinMode(3, INPUT);
          pinMode(1, INPUT);

          ESP_LOGI("WIEGAND", "RX mode activated");
      - delay: 500ms
      - globals.set:
          id: mode_switching
          value: "false"

button:
  # Restart –±—É—Ç–æ–Ω
  - platform: restart
    name: "ESP32-CAM Restart"

  # –ë—É—Ç–æ–Ω –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ
  - platform: template
    name: "Send Tag to SBOARD"
    id: send_tag_to_sboard
    on_press:
      - if:
          condition:
            lambda: "return !id(wiegand_mode);"
          then:
            - logger.log:
                level: ERROR
                format: "ERROR: Switch to TX mode first!"
          else:
            - lambda: |-
                uint32_t code = id(tag_to_send);
                uint8_t bits = 26;

                ESP_LOGI("WIEGAND_TX", "Sending tag: %lu", code);

                // Wiegand –∏–∑–ø—Ä–∞—â–∞–Ω–µ
                for (int i = bits - 1; i >= 0; i--) {
                  bool bit = (code >> i) & 1;
                  
                  if (bit) {
                    digitalWrite(1, LOW);
                    delayMicroseconds(50);
                    digitalWrite(1, HIGH);
                  } else {
                    digitalWrite(3, LOW);
                    delayMicroseconds(50);
                    digitalWrite(3, HIGH);
                  }
                  
                  delayMicroseconds(2000);
                }

                ESP_LOGI("WIEGAND_TX", "Tag sent!");
  # –ë—É—Ç–æ–Ω —Å –ø—Ä–∞–≤–∏–ª–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏—è
  - platform: template
    name: "Send Tag (26-bit Wiegand)"
    id: send_tag_wiegand26
    on_press:
      - if:
          condition:
            lambda: "return !id(wiegand_mode);"
          then:
            - logger.log:
                level: ERROR
                format: "ERROR: Switch to TX mode first!"
          else:
            - lambda: |-
                uint8_t facility = id(facility_code);
                uint16_t card = id(card_number);

                // –ö–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞–π 24-bit payload (–±–µ–∑ parity)
                uint32_t payload = ((uint32_t)facility << 16) | card;

                ESP_LOGI("WIEGAND_TX", "================================");
                ESP_LOGI("WIEGAND_TX", "Facility: %d, Card: %d", facility, card);
                ESP_LOGI("WIEGAND_TX", "Payload: 0x%06X", payload);

                // –ò–∑—á–∏—Å–ª–∏ Even Parity (–ø—ä—Ä–≤–∏—Ç–µ 13 –±–∏—Ç–∞)
                uint8_t even_count = 0;
                for (int i = 24; i >= 13; i--) {
                  if (payload & (1 << i)) even_count++;
                }
                bool even_parity = (even_count % 2) == 0 ? 0 : 1;

                // –ò–∑—á–∏—Å–ª–∏ Odd Parity (–ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 13 –±–∏—Ç–∞)
                uint8_t odd_count = 0;
                for (int i = 12; i >= 0; i--) {
                  if (payload & (1 << i)) odd_count++;
                }
                bool odd_parity = (odd_count % 2) == 0 ? 1 : 0;

                ESP_LOGD("WIEGAND_TX", "Even Parity: %d, Odd Parity: %d", even_parity, odd_parity);

                // –ò–∑–ø—Ä–∞—Ç–∏ 26-bit —Å parity
                // –ë–∏—Ç 0: Even Parity
                if (even_parity) {
                  digitalWrite(1, LOW);
                  delayMicroseconds(50);
                  digitalWrite(1, HIGH);
                } else {
                  digitalWrite(3, LOW);
                  delayMicroseconds(50);
                  digitalWrite(3, HIGH);
                }
                delayMicroseconds(2000);

                // –ë–∏—Ç–æ–≤–µ 1-24: Payload
                for (int i = 23; i >= 0; i--) {
                  bool bit = (payload >> i) & 1;
                  
                  if (bit) {
                    digitalWrite(1, LOW);
                    delayMicroseconds(50);
                    digitalWrite(1, HIGH);
                  } else {
                    digitalWrite(3, LOW);
                    delayMicroseconds(50);
                    digitalWrite(3, HIGH);
                  }
                  delayMicroseconds(2000);
                }

                // –ë–∏—Ç 25: Odd Parity
                if (odd_parity) {
                  digitalWrite(1, LOW);
                  delayMicroseconds(50);
                  digitalWrite(1, HIGH);
                } else {
                  digitalWrite(3, LOW);
                  delayMicroseconds(50);
                  digitalWrite(3, HIGH);
                }

                ESP_LOGI("WIEGAND_TX", "26-bit tag sent!");
                ESP_LOGI("WIEGAND_TX", "================================");
  # –ë—ä—Ä–∑ —Ç–µ—Å—Ç
  - platform: template
    name: "Quick Test"
    on_press:
      - switch.turn_on: tx_mode_switch
      - delay: 1s
      - button.press: send_tag_to_sboard
      - delay: 3s
      - switch.turn_off: tx_mode_switch
